<?php // $Id: viewmail.html,v 1.3 2006/10/08 12:28:57 tmas Exp $
/**
 * This page show mails at user.
 *
 * @author Toni Mas
 * @version $Id: viewmail.html,v 1.3 2006/10/08 12:28:57 tmas Exp $
 * @package email
 * @license The source code packaged with this file is Free Software, Copyright (C) 2006 by
 *          <toni.mas at uib dot es>.
 *          It's licensed under the AFFERO GENERAL PUBLIC LICENSE unless stated otherwise.
 *          You can get copies of the licenses here:
 *                         http://www.affero.org/oagpl.html
 *          AFFERO GENERAL PUBLIC LICENSE is also included in the file called "COPYING".
 **/
?>

<table class="sitetopic" border="0" cellpadding="5" cellspacing="0" width="100%">
    <tr class="headermail">
        <td style="border-left: 1px solid black; border-top:1px solid black" width="7%" align="center">
            <?php
                echo $OUTPUT->user_picture($writer, array('courseid'=>$COURSE->id));
            ?>
        </td>
        <td style="border-right: 1px solid black; border-top:1px solid black" align="left" colspan="2">
            <?php echo $mail->subject;?>
        </td>
    </tr>
    <tr>
        <td  style="border-left: 1px solid black; border-right: 1px solid black; border-top:1px solid black" align="left" colspan="3">
            &nbsp;&nbsp;&nbsp;
            <b><?php echo get_string('from','email');?>:</b>
            <?php echo fullname($writer);?>
        </td>
    </tr>
    <tr>
        <td style="border-left: 1px solid black;" width="80%" align="left" colspan="2">
            &nbsp;&nbsp;&nbsp;
            <b><?php echo get_string('for','email');?>:</b>
            <?php
                echo $userstosendto;
            ?>
        </td>
        <td style="border-right: 1px solid black;" width="20%">
            <?php
                if ( $urlnextmail or $urlpreviousmail ) {
                    echo "&nbsp;&nbsp;&nbsp;||&nbsp;&nbsp;&nbsp;";
                }
                if( $urlpreviousmail )
                {
                    echo '<a href="view.php?'. $urlpreviousmail .'">' . get_string('previous','email') . '</a>';
                }
                if( $urlnextmail )
                {
                    if ( $urlpreviousmail ) {
                        echo ' | ';
                    }
                    echo '<a href="view.php?'. $urlnextmail .'">' . get_string("next","email").'</a>';
                }
            ?>
            &nbsp;&nbsp;
        </td>
    </tr>

    <?php

        if ( $userstosendcc != '' ) {
            echo '<tr>
                    <td  style="border-left: 1px solid black; border-right: 1px solid black;" align="left" colspan="3">
                        &nbsp;&nbsp;&nbsp;
                        <b> ' . get_string('cc','email') . ':</b> ' . $userstosendcc . '
                    </td>
                </tr>';
        }

        if ( $userstosendbcc != '' ) {
            echo '<tr>
                    <td  style="border-left: 1px solid black; border-right: 1px solid black;" align="left" colspan="3">
                        &nbsp;&nbsp;&nbsp;
                        <b> ' . get_string('bcc','email') . ':</b> ' . $userstosendbcc . '
                    </td>
                </tr>';
        }
    ?>

    <tr>
        <td style="border-left: thin solid black; border-right: 1px solid black" width="60%" align="left" colspan="3">
            &nbsp;&nbsp;&nbsp;
            <b><?php echo get_string('date','email');?>:</b>

            <?php
                echo userdate($mail->timecreated);
            ?>
        </td>
    </tr>
    
    
    <tr>
        <td style="border-left: thin solid black; border-right: 1px solid black" width="60%" align="left" colspan="3">
            &nbsp;&nbsp;&nbsp;
            <b><?php echo get_string('attachment','email');?>:</b>

            <?php
                $context = context_module::instance($cm->id);
                $fs = get_file_storage();
                $files = $fs->get_area_files($context->id, 'mod_email', 'attachments', $mail->id);
                $tmp = '';
                foreach ($files as $f) {
                    // $f is an instance of stored_file
                    $filename = $f->get_filename();
                    if($filename != '.'){
                        $url = "{$CFG->wwwroot}/pluginfile.php/{$f->get_contextid()}/mod_email/attachments";
                        $fileurl = $url.$f->get_filepath().$f->get_itemid().'/'.$filename;
                        $tmp .= html_writer::link($fileurl, $filename);
                    }
                }
                echo $tmp;
            ?>
        </td>
    </tr>


    <tr>
        <td style="border: 1px solid black" colspan="3" align="left">
            <br />
            <?php
                $mail->body = file_rewrite_pluginfile_urls($mail->body, 'pluginfile.php', $context->id, 'mod_email', 'body', $mail->id);
                echo text_to_html($mail->body, true, false);
            ?>
            <br />
            <br />
        </td>
    </tr>
    <tr>
        <td align="right" colspan="3">
            <?php
                echo '<a href="view.php?'.$urltoreply.'"><b>'. get_string('reply','email'). '</b></a>';
                echo ' | ';
                echo '<a href="view.php?'.$urltoreplyall.'"><b>'. get_string('replyall','email'). '</b></a>';
                echo ' | ';
                echo '<a href="view.php?'.$urltoforward.'"><b>'. get_string('forward','email'). '</b></a>';
                echo ' | ';
                echo '<a href="view.php?'.$urltoremove.'"><b>'. get_string('removemail','email'). '</b></a>';
            ?>

        </td>
    </tr>
</table>